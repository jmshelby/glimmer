#!/bin/bash

# Glimmer Local Development Server
# Starts server on port 4000 by default

PORT=${1:-4000}

echo "ğŸš€ Starting Glimmer local server on port $PORT..."
echo "ğŸ“ Health check: http://localhost:$PORT/health"
echo "ğŸ”— API endpoint: http://localhost:$PORT/glimmer/op"
echo ""

clj -M:dev -e "
(require '[local.server :as server]
         '[glimmer.app.config :as config]
         '[glimmer.app.datomic :as db]
         '[glimmer.app.db.schema :as schema]
         '[glimmer.datomic.connect :as dcon]
         '[clojure.pprint :as pprint])

(println \"ğŸ“‹ App Configuration:\")
(println \"   App Name:\" (config/app))
(println \"   Environment:\" (config/env))
(println \"   Config:\")
(pprint/pprint (config/get))
(println \"\")

(println \"ğŸ—„ï¸  Ensuring database schema...\")
(let [cfg (config/get)
      client (db/client cfg)
      db-name (:datomic/db-name cfg)
      ! (dcon/get-connection client db-name)]
  (schema/ensure-schema! !)
  (println \"âœ… Schema ready\"))
(println \"\")

(println \"ğŸŒ Starting server...\")
(server/run-dev $PORT)
(println \"âœ… Server running on port $PORT\")
@(promise)"